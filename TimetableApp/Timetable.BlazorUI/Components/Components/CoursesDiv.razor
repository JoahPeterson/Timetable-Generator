@using Microsoft.AspNetCore.Authorization
@inject IJSRuntime JS
@inject ICourseData CourseData
@inject IUserData UserData
@inject NavigationManager Navigation
@inject AuthenticationStateProvider authProvider
@inject IModalService Modal;
@rendermode InteractiveServer
@* @inject Blazored.Modal.Services.IModalService Modal *@

@attribute [Authorize]

@if (courses != null && loggedInUser != null)
{
    var colorClasses = new List<string> { "Cardcolor-1", "Cardcolor-2" };

    <div class="darkdiv p-3 rounded-3 shadow">
        <h2 class="text-center"><i class="bi bi-table"></i> My Timetables</h2>
        <hr />
        <div class="card scrollable-card">
            <ul class="list-group list-group-flush">
                @foreach (var (course, index) in courses.Select((value, i) => (value, i)))
                {
                    var colorClass = colorClasses.ElementAtOrDefault(index % colorClasses.Count) ?? "Cardcolor-1";  // Ensure safe access
                    <li class="list-group-item CardText text-black px-3 d-flex justify-content-between @colorClass"
                        data-toggle="tooltip" data-placement="top" title="@course.Description">
                        <div>
                            <i class="bi bi-journal-bookmark h4"></i>
                            <a href="/timetable/@course.Id" class="text-black text-decoration-none fw-bold">@course.Name</a>
                        </div>
                        <a class="text-black text-decoration-none fw-bold ms-auto" @onclick="() => ShowModal(course)">
                            <i class="bi bi-dash-circle h5"></i>
                        </a>
                    </li>
                }
            </ul>
        </div>
        <div class="mt-4 fixed">
            <a href="course/create" class="text-black text-decoration-none CardText">
                <i class="bi bi-plus-circle h5"></i> Add
            </a>
        </div>
    </div>
}
else
{
    <p>Loading courses...</p>
}

@code {
    private List<Course>? courses;
    private User? loggedInUser;
    private bool showConfirmationModal = false;
    Course selectedCourse = null;

    protected override async Task OnInitializedAsync()
    {
        var authState = await authProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        var userIdClaim = user.Claims.FirstOrDefault(c => c.Type.Contains("nameidentifier"))?.Value;

        if (!string.IsNullOrEmpty(userIdClaim))
        {
            loggedInUser = await UserData.GetUserFromAuthenticationAsync(userIdClaim);

            if (loggedInUser != null)
            {
                courses = await CourseData.GetUsersCoursesAsync(loggedInUser.Id);
            }
        }

        //await ShowDeleteConfirmation(courses[0]);
    }

    public async Task Archive()
    {
        showConfirmationModal = false;

        if (selectedCourse == null)
            return;

        selectedCourse.AuditInformation.LastModified = DateTime.Now;
        selectedCourse.AuditInformation.IsArchived = true;
        await CourseData.UpdateCourseAsync(selectedCourse);

        if (courses is not null)
            courses.Remove(selectedCourse);

        StateHasChanged();
    }

    private async Task ShowModal(Course course)
    {
        selectedCourse = course;
        await JS.InvokeVoidAsync("modalInterop.showModal", "modal-1");
    }

    private async Task HideModal()
    {
        await JS.InvokeVoidAsync("modalInterop.hideModal", "modal-1");
    }

    // private async Task OnConfirmationResult(bool confirmed, Course course)
    // {
    //     showConfirmationModal = false; // Hide the modal
    //     if (confirmed)
    //     {
    //         await Archive(course);
    //     }
    // }

    // private async Task ShowDeleteConfirmation(Course course)
    // {
    //     var parameters = new ModalParameters();
    //     parameters.Add("Message", $"Are you sure you want to delete the course '{course.Name}'?");

    //     var modal = Modal.Show<ConfirmationDialog>("Confirm Delete", parameters);
    //     var result = await modal.Result;

    //     if (!result.Cancelled)
    //     {
    //         await OnConfirmationResult(true, course);
    //     }
    // }

}

